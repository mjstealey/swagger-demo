<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="generator" content="Hugo 0.21" />
    <meta name="description" content="Exposures API Example">


    <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />

    <title>6. Exposures API :: Swagger Demo</title>
    <link href="/swagger-demo/css/nucleus.css" rel="stylesheet">
    <link href="/swagger-demo/css/font-awesome.min.css" rel="stylesheet">
    <link href="/swagger-demo/css/hybrid.css" rel="stylesheet">
    <link href="/swagger-demo/css/featherlight.min.css" rel="stylesheet">
    <link href="/swagger-demo/css/horsey.css" rel="stylesheet">
    <link href="/swagger-demo/css/theme.css" rel="stylesheet">
    <link rel="stylesheet" href="/swagger-demo/css/bootstrap.min.css">
    <script src="/swagger-demo/js/jquery-2.x.min.js"></script>
    <style type="text/css">
      :root #header + #content > #left > #rlblock_left {
        display:none !important;
      }
    </style>

    

    

  </head>
  <body class="" data-url="/swagger-demo/exposures/">
    
<nav id="sidebar" class="">
  <div id="header-wrapper">
    <div id="header">
       
	<p>Swagger Demo</p>
 


    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fa fa-search"></i></label>
    <input data-search-input id="search-by" type="text" placeholder="Search...">
    <span data-search-clear=""><i class="fa fa-close"></i></span>
</div>
<script type="text/javascript" src="/swagger-demo/js/lunr.min.js"></script>
<script type="text/javascript" src="/swagger-demo/js/horsey.js"></script>
<script type="text/javascript">
    var baseurl = "https:\/\/mjstealey.github.io\/swagger-demo\/";
</script>
<script type="text/javascript" src="/swagger-demo/js/search.js"></script>

    
  </div>

  <div class="highlightable">
    <ul class="topics">
        
            <li data-nav-id="/swagger-demo/" class="dd-item">
            <a href="/swagger-demo/"><i class="fa fa-fw fa-home"></i></a>
            </li>
        

        
        
        
        
        
            
    
    
    
    
        <li data-nav-id="/swagger-demo/swagger/" class="dd-item 
         
        
        "
        >
            <a href="/swagger-demo/swagger/">
                <span>1. What is Swagger?</span>
                
                
            </a>
            
            
            
        </li>
    

        
            
    
    
    
    
        <li data-nav-id="/swagger-demo/smartapi/" class="dd-item 
         
        
        "
        >
            <a href="/swagger-demo/smartapi/">
                <span>2. Swagger vs SmartAPI</span>
                
                
            </a>
            
            
            
        </li>
    

        
            
    
    
    
    
        <li data-nav-id="/swagger-demo/apispec/" class="dd-item 
         
        
        "
        >
            <a href="/swagger-demo/apispec/">
                <span>3. API Specification</span>
                
                
            </a>
            
            
            
        </li>
    

        
            
    
    
    
    
        <li data-nav-id="/swagger-demo/apiserver/" class="dd-item 
         
        
        "
        >
            <a href="/swagger-demo/apiserver/">
                <span>4. API Server</span>
                
                
            </a>
            
            
            
        </li>
    

        
            
    
    
    
    
        <li data-nav-id="/swagger-demo/apiclient/" class="dd-item 
         
        
        "
        >
            <a href="/swagger-demo/apiclient/">
                <span>5. API Client</span>
                
                
            </a>
            
            
            
        </li>
    

        
            
    
    
    
    
        <li data-nav-id="/swagger-demo/exposures/" class="dd-item 
        active 
        
        "
        >
            <a href="/swagger-demo/exposures/">
                <span>6. Exposures API</span>
                
                    
                        <i class="fa fa-angle-down fa-lg category-icon"></i>
                    
                
                
            </a>
            
                
                
                
                    
                
            
            
            
                <ul>
                
                    
    
    
    
    
        <li data-nav-id="/swagger-demo/swaggeryaml/" class="dd-item 
         
        
        "
        >
            <a href="/swagger-demo/swaggeryaml/">
                <span>Swagger YAML file</span>
                
                
            </a>
            
            
            
        </li>
    

                
                    
    
    
    
    
        <li data-nav-id="/swagger-demo/pythonserver/" class="dd-item 
         
        
        "
        >
            <a href="/swagger-demo/pythonserver/">
                <span>Python-Flask Server</span>
                
                
            </a>
            
            
            
        </li>
    

                
                    
    
    
    
    
        <li data-nav-id="/swagger-demo/pythonclient/" class="dd-item 
         
        
        "
        >
            <a href="/swagger-demo/pythonclient/">
                <span>Python Client</span>
                
                
            </a>
            
            
            
        </li>
    

                
                </ul>
             
        </li>
    

        
            
    
    
    
    
        <li data-nav-id="/swagger-demo/references/" class="dd-item 
         
        
        "
        >
            <a href="/swagger-demo/references/">
                <span>References</span>
                
                
            </a>
            
            
            
        </li>
    

        

        

        
        
        
        <section id="shortcuts">
            
                <li class="" role="">
                    <h3>More</h3>
                    <a href="https://github.com/mjstealey/swagger-demo/"><i class='fa fa-github'></i> mjstealey/swagger-demo</a>
                    
                </li>
            
                <li class="" role="">
                    
                    <a href="https://github.com/mjstealey/exposures-api"><i class='fa fa-github'></i> mjstealey/exposures-api</a>
                    
                </li>
            
                <li class="" role="">
                    
                    <a href="https://github.com/WebsmartAPI"><i class='fa fa-github'></i> WebsmartAPI (smartAPI)</a>
                    
                </li>
            
                <li class="" role="">
                    
                    <a href="https://github.com/swagger-api"><i class='fa fa-github'></i> swagger-api</a>
                    
                </li>
            
                <li class="" role="">
                    
                    <a href="http://smart-api.info"><i class='fa fa-bookmark'></i> smartAPI Documentation</a>
                    
                </li>
            
                <li class="" role="">
                    
                    <a href="http://swagger.io/docs/"><i class='fa fa-bookmark'></i> swagger.io Documentation</a>
                    
                </li>
            
                <li class="" role="">
                    
                    <a href="https://app.swaggerhub.com/"><i class='fa fa-bookmark'></i> swaggerhub</a>
                    
                </li>
            
        </section>    
        
        

        
    </ul>
    
     
    <section id="footer">
      
    </section>
  </div>
</nav>



        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
        
          <div id="top-bar">
            

            <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                <span id="sidebar-toggle-span">
                  <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                    <i class="fa fa-bars"></i>
                  </a>
                </span>
                <span id="toc-menu"><a href=""><i class="fa fa-list-alt"></i></a></span>
                <a href="https://mjstealey.github.io/swagger-demo/">
                  <span class="fa fa-arrow-circle-right" style="font-size:larger" aria-hidden="true"></span>
                  Swagger Demo
                </a>
                
                   / <a href='/swagger-demo/exposures/'>6. Exposures API</a>
                
                
            </div>
            <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#specification-in-swagger">Specification in Swagger</a></li>
<li><a href="#python-flask-server">Python-Flask Server</a></li>
<li><a href="#python-client">Python Client</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

          </div>
        
        
        <div id="body-inner">
          
            <h1>6. Exposures API</h1>
          




<p>Short walkthrough example of how the Exposures API was implemented using swagger tools in Python.</p>

<h3 id="specification-in-swagger">Specification in Swagger</h3>

<p>At the start we had a notion of the data we wanted to serve, a list of sources to get it from, and a good idea of what this data looked like with some example datasets in a PostgreSQL / PostGIS database. Based on this information a specification file was started prior to the existence of any ReSTful service provider, so going down the rabbit hole of the swagger eco-system seemed a sensible thing to do.</p>

<p>We started with a <a href="https://mjstealey.github.io/swagger-demo/
/swaggeryaml">specification</a> in swagger:</p>

<pre><code class="language-yaml">swagger: &quot;2.0&quot;
info:
  title: &quot;Environmental Exposures API&quot;
  version: &quot;1.0.0&quot;
  contact:
    name: &quot;Michael J. Stealey&quot;
    email: &quot;stealey@renci.org&quot;
    url: &quot;http://renci.org&quot;
    #responsibleDeveloper: &quot;Michael J. Stealey&quot;
    #responsibleOrganization: &quot;RENCI&quot;
  description: &quot;API for environmental exposure models for NIH Data Translator program&quot;
  termsOfService: &quot;None Available&quot;
host: exposures.renci.org
basePath: /v1
schemes:
 - https
 - http

paths:
  /exposures:
    get:
      summary: &quot;Get list of exposure types&quot;
      description: &quot;Returns a list of all available exposure types&quot;
      produces:
        - application/json
      responses:
        200:
          description: &quot;Exposure types&quot;
          schema:
            type: array
            items:
              $ref: '#/definitions/exposure_type'
        404:
          description: &quot;No exposure types found&quot;
...
</code></pre>

<p>A couple early versions of the specification did make it into the smartAPI registry, but when copying an updated specification to the <a href="http://smart-api.info/editor/#/">smart-api.info/editor</a> it yielded no errors, however when the “Save” button is pressed it generates a pop-up error, even though the editor states “All changes saved”.</p>

<p>Reference: <code>Error&quot;&lt;html&gt;&lt;title&gt;500: Internal Server Error&lt;/title&gt;&lt;body&gt;500: Internal Server Error&lt;/body&gt;&lt;/html&gt;&quot;</code></p>

<h3 id="python-flask-server">Python-Flask Server</h3>

<p>The swagger-editor offers an option to generate server stubs using swagger-codegen in many different languages. We chose to implement our Exposures API in Python and used the <strong>python-flask</strong> option.</p>

<p><img src="https://mjstealey.github.io/swagger-demo/
/images/pythonserver.png" alt="Python-flask server" /></p>

<p>The <a href="https://github.com/mjstealey/swagger-demo/tree/master/python-flask-server-generated">resultant code</a> gives some suggestion as to how it &ldquo;should&rdquo; be implemented and made reference to a <a href="https://github.com/zalando/connexion">Connexion</a> library on top of Flask.</p>

<p><img src="https://mjstealey.github.io/swagger-demo/
/images/generatedserver.png" alt="Swagger generated server" /></p>

<p>And when you run the code as described you get <a href="https://mjstealey.github.io/swagger-demo/
/pythonserver">this</a>.</p>

<p><strong>database</strong></p>

<p>We had a pre-existing PostgreSQL/PostGIS database that we were making use of, so there was the need to generate the appropriate models for use by our API server.</p>

<p>The initial models.py file was generated using <a href="https://pypi.python.org/pypi/sqlacodegen">sqlacodegen</a></p>

<p>Need to add import statement to <code>sqlacodegen/codegen.py</code>in order to account for <a href="https://geoalchemy-2.readthedocs.io/en/latest/">geoalchemy2</a></p>

<pre><code class="language-python">from sqlalchemy.types import Boolean, String
import sqlalchemy
from geoalchemy2 import Geometry, Geography # &lt;-- this
</code></pre>

<pre><code class="language-console">$ sqlacodegen --outfile models.py postgres://datatrans:somepassword@192.168.56.101:5432/bdtgreen
</code></pre>

<p><strong>https</strong></p>

<p>Even if we weren&rsquo;t starting with formal authentication and authorization, we at minimum wanted to enable https for all of our services. The documentation for how to do this is straight forward enough for PostgreSQL, but when it came to doing this for the <strong>swagger recommended</strong> connexion package, this is what we found&hellip;</p>

<p><img src="https://mjstealey.github.io/swagger-demo/
/images/connexion.png" alt="Connexion readthedocs" /></p>

<p>After some package reconnaissance we turned up a way to enable https using native <a href="http://www.gevent.org/gevent.server.html">gevent</a> features which is an option in the connexion package. This involved a couple extra parameters and <a href="https://en.wikipedia.org/wiki/Monkey_patch">monkey patching</a>.</p>

<p><code>app.py</code>:</p>

<pre><code class="language-python">#!/usr/bin/env python3

import connexion
from configparser import ConfigParser
from flask_cors import CORS
from gevent import monkey     # &lt;-- this
monkey.patch_all()            # &lt;-- this

if __name__ == '__main__':
    parser = ConfigParser()
    parser.read('ini/connexion.ini')
    app = connexion.App(__name__, specification_dir='./swagger/', server=parser.get('connexion', 'server'))
    app.add_api('swagger.yaml', arguments={'title': 'Environmental Exposures API'})
    if not parser.get('connexion', 'certfile') or not parser.get('connexion', 'keyfile'):
        app.run(port=int(parser.get('connexion', 'port')),
                debug=parser.get('connexion', 'debug'))
    else:
        CORS(app.app)
        app.run(port=int(parser.get('connexion', 'port')),
                debug=parser.get('connexion', 'debug'),
                keyfile=parser.get('connexion', 'keyfile'),   # &lt;-- this
                certfile=parser.get('connexion', 'certfile')  # &lt;-- and this
                )
</code></pre>

<p>As with most things our Exposures API is ever evolving and still requires much optimizing with respect to database queries to be more efficient / timely.</p>

<p><strong>Docker</strong></p>

<p>Finally we packaged everything up to be Docker distributable so that deployment could be made rapidly across multiple endpoints as needed to satisfy a reverse proxy load balancer.</p>

<p>The Environmental Exposures API is available in docker as <a href="https://hub.docker.com/r/mjstealey/exposures_api/">mjstealey/exposures_api</a>. There is an assumption that it will be used to connect to a PostgreSQL/PostGIS database pre-populated with the appropriate environmental exposures data tables.</p>

<p>Usage examples will be given in the context of the sample database included in this repository.</p>

<p>Example:</p>

<pre><code class="language-console">$ docker pull mjstealey/exposures_api
$ docker run -d \
	--name api-server \
	-e POSTGRES_HOST=backend.postgres.server \
	-e POSTGRES_PORT=5432 \
	-e POSTGRES_DATABASE=bdtgreen \
	-e POSTGRES_USERNAME=datatrans \
	-e POSTGRES_PASSWORD=somepassword \
	-p 5000:5000 \
	mjstealey/exposures_api
</code></pre>

<p>Once completed the exposures_api would be running at <a href="http://localhost:5000/v1/ui/#/">http://localhost:5000/v1/ui/#/</a></p>

<p>The <strong>exposure_api</strong> uses environment variables to set itself up, and these can be passed in either individually, or by use of an environment file.</p>

<p>Example environment file (exposures-api.env) with default values</p>

<pre><code class="language-ini">CONNEXION_SERVER=
CONNEXION_DEBUG=True
API_SERVER_HOST=localhost
API_SERVER_PORT=5000
API_SERVER_KEYFILE=
API_SERVER_CERTFILE=
POSTGRES_HOST=backend
POSTGRES_PORT=5432
POSTGRES_DATABASE=bdtgreen
POSTGRES_USERNAME=datatrans
POSTGRES_PASSWORD=somepassword
POSTGRES_IP=
</code></pre>

<p>The user can define the <code>CONNEXION_SERVER</code> to be <strong>blank</strong>, <strong>gevent</strong>, or <strong>tornado</strong>. In our case we&rsquo;ll use <strong>gevent</strong>.</p>

<p>The user can also deploy using SSL certificates, as would likely be found in a prodution deployment.</p>

<p>Example (exposures-api.env):</p>

<pre><code class="language-ini">CONNEXION_SERVER=gevent
CONNEXION_DEBUG=False
API_SERVER_HOST=my.api-server.org
API_SERVER_PORT=443
API_SERVER_KEYFILE=/certs/server.key
API_SERVER_CERTFILE=/certs/server.crt
POSTGRES_HOST=backend.postgres.server
POSTGRES_PORT=5432
POSTGRES_DATABASE=bdtgreen
POSTGRES_USERNAME=datatrans
POSTGRES_PASSWORD=somepassword
POSTGRES_IP=
</code></pre>

<pre><code class="language-console">$ docker run -d \
	--name api-server \
	--env-file=exposures-api.env \
	-v /home/docker/certs:/certs  \
	-p 443:443 \
	mjstealey/exposures_api
</code></pre>

<p>Once completed the exposures_api would be running at <a href="https://my.api-server.org/v1/ui/#/">https://my.api-server.org/v1/ui/#/</a></p>

<h3 id="python-client">Python Client</h3>

<p><img src="https://mjstealey.github.io/swagger-demo/
/images/pythonclient.png" alt="Python client" /></p>


<footer class=" footline" >
	
	    <i class='fa fa-user'></i> <a href="mailto:michael.j.stealey@gmail.com">Michael J. Stealey</a>  <i class='fa fa-calendar'></i> 31/05/2017
	    </div>
	
</footer>



      </div>
    </div>

    
 
    

    <div id="navigation">
        
        
        
            
            
            
                
                    
                
                
                
            
        
        
            
            
            
                
                    
                
                
                
            
        
        
            
            
            
                
                    
                
                
                
            
        
        
            
            
            
                
                    
                
                
                
            
        
        
            
            
            
                
                    
                
                
                
            
        
        
            
            
            
                
                    
                    
                
                
                
                    
            
            
                
                    
                        
                        
                    
                
                
                
            
        
                
                    
            
            
                
                    
                
                
                
            
        
                
                    
            
            
                
                    
                
                
                
            
        
                
            
        
        
            
            
            
                
                    
                
                
                
            
        
          

        


        
            <a class="nav nav-prev" href="/swagger-demo/apiclient/" title="5. API Client"> <i class="fa fa-chevron-left"></i></a>
        
        
            <a class="nav nav-next" href="/swagger-demo/swaggeryaml/" title="Swagger YAML file" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
        
    </div>

    </section>
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/swagger-demo/js/clipboard.min.js"></script>
    <script src="/swagger-demo/js/jquery.sticky-kit.min.js"></script>
    <script src="/swagger-demo/js/featherlight.min.js"></script>
    <script src="/swagger-demo/js/html5shiv-printshiv.min.js"></script>
    <script src="/swagger-demo/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/swagger-demo/js/modernizr.custom.71422.js"></script>
    <script src="/swagger-demo/js/learn.js"></script>
    <script src="/swagger-demo/js/hugo-learn.js"></script>

    
    <link href="/swagger-demo/mermaid/mermaid.css" type="text/css" rel="stylesheet"/>
    <script src="/swagger-demo/mermaid/mermaid.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    

    

  </body>
</html>

